@page "/plateau"
@namespace EquipeJeuDeRole.Pages
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Text.Json.Serialization
@inject EntityService EntityService
@inject IJSRuntime JsRuntime






@code {
    
    

    protected override async Task OnInitializedAsync()
    {
        
        try
        {
            if (JsRuntime == null || EntityService == null)
            {
                Console.WriteLine("JSRuntime or EntityService is null.");
                return;
            }

            var serializedData = await JsRuntime.InvokeAsync<string>("localStorage.getItem", "pageStateData");

            if (!string.IsNullOrEmpty(serializedData))
            {
                Console.WriteLine($"Données récupérées de localStorage : {serializedData}");
                var options = new JsonSerializerOptions
                {
                    Converters = { new JsonStringEnumConverter()}
                };
                var plateauState = JsonSerializer.Deserialize<PlateauState>(serializedData, options);

                terrain1 = plateauState.Terrain;
                if (plateauState.Entity!=null)
                {
                    switch (plateauState.Entity.Classes)
                    {
                        case Classes.GUERRIER:
                            personnage = JsonSerializer.Deserialize<Guerrier>(JsonSerializer.Serialize(plateauState.Entity, options), options);
                            break;
                        case Classes.ARCHER:
                            personnage = JsonSerializer.Deserialize<Archer>(JsonSerializer.Serialize(plateauState.Entity, options), options);
                                break;
                        case Classes.MAGE:
                                break;
                                    
                    }
                }
                
                monstre = plateauState.Monstre;
                Console.WriteLine($"Personnage : {personnage}");
                Console.WriteLine($"Monstre : {plateauState.Monstre}");
                Console.WriteLine($"Terrain : {plateauState.Terrain}");

                if (personnage != null)
                {
                    terrain1.plateau[personnage.row, personnage.col] = personnage;
                }

                if (monstre != null)
                {
                    terrain1.plateau[monstre.row, monstre.col] = monstre;
                }
                Sauvegarde();
            }
            else
            {
                personnage = EntityService.Entity;
                terrain1 = new Terrain();
                personnage.row = terrain1.plateau.GetLength(0) / 2;
                personnage.col = terrain1.plateau.GetLength(1) / 2;
                monstre = new Monstre();
                monstre.row = 49;
                monstre.col = 49;

                terrain1.plateau[personnage.row, personnage.col] = personnage;
                terrain1.plateau[monstre.row, monstre.col] = monstre;

                Console.WriteLine(terrain1.plateau.GetLength(0));
                Sauvegarde();
            }
            
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur dans OnInitializedAsync : {ex.Message}");
        }

        await base.OnInitializedAsync();
    }



    public void Sauvegarde()
    {
        var plateauState = new
        {
            Entity = personnage,
            Monstre= monstre,
            Terrain = terrain1
        };
        
        try
        {
            var options = new JsonSerializerOptions
            {
                Converters = { new JsonStringEnumConverter() }
            };
            var serializedData = System.Text.Json.JsonSerializer.Serialize(plateauState, options);
            JsRuntime.InvokeVoidAsync("localStorage.setItem", "pageStateData", serializedData);
        }
        catch (JsonException ex)
        {
            Console.WriteLine($"Erreur de sérialisation JSON : {ex.Message}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la sauvegarde : {ex.Message}");
        }
    }

    string AfficherContenuCellule(int row, int col)
    {
        try
        {
            int targetRow = personnage?.row + row ?? 0;
            int targetCol = personnage?.col + col ?? 0;

            if (terrain1 != null &&
                terrain1.plateau != null &&
                targetRow >= 0 && targetRow < terrain1.plateau.GetLength(0) &&
                targetCol >= 0 && targetCol < terrain1.plateau.GetLength(1))
            {
                Entity? cellEntity = terrain1.plateau[targetRow, targetCol];

                if (cellEntity != null)
                {
                    // Vérifiez le type de l'entité
                    if (cellEntity.GetType() == typeof(Guerrier) || cellEntity.GetType() ==typeof(Archer))
                    {
                        // Si c'est un Entity Classe, retournez "P" par exemple
                        return "P";
                    }
                    else if (cellEntity.GetType() == typeof(Monstre))
                    {
                        // Si c'est un Monstre, retournez "M" par exemple
                        return "M";
                    }
                    else
                    {
                        // Autre type d'entité, ajustez le symbole selon vos besoins
                        return "X";
                    }
                }
                else
                {
                    // Si l'entité est null, affichez autre chose
                    return "0";
                }
            }
            else
            {
                Console.WriteLine($"Erreur dans AfficherContenuCellule : terrain1 ou plateau est null, targetRow={targetRow}, targetCol={targetCol}");
                return "*";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur dans AfficherContenuCellule : {ex.Message}");
            return "*";
        }
    }




    private void HandleKeyDown(KeyboardEventArgs touche)
    {
        int targetRow = personnage.row;
        int targetCol = personnage.col;

        switch (touche.Key)
        {
            case "ArrowLeft":
                Console.WriteLine("Je bouge à gauche ");
                targetCol--;
                break;
            case "ArrowRight":
                Console.WriteLine("Je bouge à droite ");
                targetCol++;
                break;
            case "ArrowUp":
                Console.WriteLine("Je bouge en haut ");
                targetRow--;
                break;
            case "ArrowDown":
                Console.WriteLine("Je bouge en bas ");
                targetRow++;
                break;
        }

    // Vérifiez si les nouvelles coordonnées sont dans les limites du tableau
        if (IsDansLimites(targetRow, targetCol))
        {
    // Vérifiez s'il y a un monstre à la nouvelle position
            Entity? targetEntity = terrain1.plateau[targetRow, targetCol];

            if (targetEntity != null && targetEntity.GetType() == typeof(Monstre))
            {
    // Si un monstre est rencontré, redirigez vers la zone de combat
                AfficherZoneCombat();
            }
            else
            {
                DeplacerVersNouvellePosition(targetRow, targetCol);
            }
        }
        else
        {
            Console.WriteLine("Déplacement en dehors des limites du tableau");
        }
    }
    
    private bool IsDansLimites(int row, int col)
    {
        return row >= 0 && row < terrain1.plateau.GetLength(0) && col >= 0 && col < terrain1.plateau.GetLength(1);
    }

    private void DeplacerVersNouvellePosition(int targetRow, int targetCol)
    {
        terrain1.plateau[personnage.row, personnage.col] = null;
        personnage.row = targetRow;
        personnage.col = targetCol;
        terrain1.plateau[personnage.row, personnage.col] = personnage;
        Sauvegarde();
        StateHasChanged();
    }

    private void AfficherZoneCombat()
    {
        showPlateau = false;
    // Ajoutez toute logique supplémentaire liée à la transition vers la zone de combat ici
    // Par exemple, vous voudrez peut-être configurer l'environnement de combat ou initier une bataille.
    }
    
    
    public void Deplacer(Deplacement direction)
    {
        int targetRow = personnage.row;
        int targetCol = personnage.col;
        switch (direction)
        {
            case Deplacement.LEFT:
                if (personnage.col > 0) // Vérifie si le déplacement à gauche est possible
                    personnage.col--;
                break;
            case Deplacement.RIGHT:
                if (personnage.col < terrain1.plateau.GetLength(1) - 1) // Vérifie si le déplacement à droite est possible
                    personnage.col++;
                break;
            case Deplacement.UP:
                if (personnage.row > 0) // Vérifie si le déplacement vers le haut est possible
                    personnage.row--;
                break;
            case Deplacement.DOWN:
                if (personnage.row < terrain1.plateau.GetLength(0) - 1) // Vérifie si le déplacement vers le bas est possible
                    personnage.row++;
                break;
        }
    // Vérifiez si les nouvelles coordonnées sont dans les limites du tableau
        if (targetRow >= 0 && targetRow < terrain1.plateau.GetLength(0) && targetCol >= 0 && targetCol < terrain1.plateau.GetLength(1))
        {
    // Vérifiez s'il y a un monstre à la nouvelle position
            Entity? targetEntity = terrain1.plateau[targetRow, targetCol];

            if (targetEntity != null && targetEntity.GetType() == typeof(Monstre))
            {
    // Si un monstre est rencontré, redirigez vers la zone de combat
               
            }
            else
            {
                terrain1.plateau[personnage.row, personnage.col] = null;
                personnage.row = targetRow;
                personnage.col = targetCol;
                terrain1.plateau[personnage.row, personnage.col] = personnage;
                Sauvegarde();
                StateHasChanged();
            }
        }
        else
        {
            Console.WriteLine("Déplacement en dehors des limites du tableau");
        }
    }
    

    public void ShowPlateau()
    {
        showPlateau = false;
    }

    public Terrain? terrain1;
    public Entity? personnage;
    public Entity? monstre;
    public bool showPlateau = true;



}




<PageTitle>Plateau</PageTitle>
<h3>Plateau</h3>
<ul>
    <li><NavLink href="/" class="btn btn-primary">Quitter le jeu</NavLink></li>
</ul>
@if (showPlateau)
{
@if (personnage != null)
{
    <div class="board" @onkeydown="HandleKeyDown" tabindex="0" autofocus style="outline:none">
        @for (int i = -4; i < 6; i++)
        {
            <div class="zc-row">
                @for (int j = -4; j < 6; j++)
                {
                    <div class="zc-cell" id=@($"{personnage.row + i}-{personnage.col + j}")>
                        @AfficherContenuCellule(i, j)
                    </div>
                }
            </div>
        }
    </div>
    <div>
        <div>Position : @($"{personnage.row}-{personnage.col}")</div>
        <div>PV : @personnage.PointDeVie</div>
    </div>

    }
}else
    {
        <PageTitle>Zone de combat</PageTitle>


        <div class="globalDiv">
            <h3>ZoneCombat</h3>
            <div class="interface1">
                <ul>
                    <li><NavLink href="Plateau" class="btn btn-primary">Retourner sur la carte </NavLink></li>
                </ul>
                <ul>
                    <li><NavLink href="/" class="btn btn-primary">Quitter le jeu</NavLink></li>
                </ul>

            </div>
            <div class="ZoneCombat">

            </div>
            <div class="interface1">
                <div class="zoneTxtCombat">
           
                </div>
                <div class="espAttac">
                    <div class="listeAttaques">
                        <ul>
                            <li><button class="attac"> action1 </button></li>
                            <li><button class="attac"> action2 </button></li>
                        </ul>
                    </div>
                    <div class="listeAttaques">
                        <ul>
                            <li><button class="attac"> action3 </button></li>
                            <li><button class="attac"> action4 </button></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    } 

   
